---
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: scc-initiator
  annotations:
    description: Initiate an SCC scan based on https://test.cloud.ibm.com/apidocs/security-compliance/posture
    app.openshift.io/description: Initiate an SCC scan based on https://test.cloud.ibm.com/apidocs/security-compliance/posture
  
spec:
  params:
    - name: tools-image
      default: quay.io/ibmgaragecloud/ibmcloud-dev:v2.0.4
    - name: location
      description: Endpoint location for the SCC api.  Values are "us" or "eu".

    - name: account_id
      description: IBM Cloud account ID.
    - name: scope_id
      description: The unique ID of the scope.
    - name: profile_id
      description: The unique ID of the profile.
    - name: group_profile_id
      description: The ID of the profile group.
    - name: apikey
      description: IBM Cloud API Key.

      

  steps:
    - name: scc-initiator
      image: $(params.tools-image)
      command: ["/bin/sh", "-c"]
      args:
        - |
          #!/bin/sh
          
          echo "SCC HERE WE GO!"
          ibmcloud login --apikey $(params.apikey) -r "us-south"

          LOCATION="$(params.location)"
          ACCOUNT_ID="$(params.account_id)"
          SCOPE_ID="$(params.scope_id)"
          PROFILE_ID="$(params.profile_id)"
          GROUP_PROFILE_ID="$(params.group_profile_id)"
          IAM_TOKEN=$(ibmcloud iam oauth-tokens --output JSON | jq ".iam_token" -r)

          echo "LOCATION: ${LOCATION}"
          echo "ACCOUNT_ID: ${ACCOUNT_ID}"
          echo "SCOPE_ID: ${SCOPE_ID}"
          echo "PROFILE_ID: ${PROFILE_ID}"
          echo "GROUP_PROFILE_ID: ${GROUP_PROFILE_ID}"
          echo "IAM_TOKEN: ${IAM_TOKEN}"

          printf "\nInitiating request to https://${LOCATION}.compliance.cloud.ibm.com/posture/v1/scans/validations?account_id=${ACCOUNT_ID}\n"
          STATUS=$(curl -s -o response.txt -w "%{http_code}" \
            -X POST  "https://${LOCATION}.compliance.cloud.ibm.com/posture/v1/scans/validations?account_id=${ACCOUNT_ID}"   \
            -H 'Authorization: Bearer ${IAM_TOKEN}'   \
            -H 'Content-type: application/json'   \
            -d '{
              "scope_id": "${SCOPE_ID}", 
              "profile_id": "${PROFILE_ID}", 
              "group_profile_id": "${GROUP_PROFILE_ID}" 
            }')

          printf "\nSTATUS: ${STATUS}\n"
          jq '.' response.txt   
          if [ $STATUS != "200" ]; then
            #if not http 200, fail the pipeline
            exit 1
          else
            exit 0
          fi
  